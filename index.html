<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="js/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="js/paper.js"></script>
    <script type="text/javascript" src="js/hanafuda.js"></script>
    <script type="text/paperscript" canvas="cardCanvas">
      var SCALE = 1 / 10;
      var gameImages = {};
      var matchedCards = [];

      var player;
      var ai;
      var deck;

      function Player(x, y) {
        this.start_x = x || 48;
        this.start_y = y || 450;
        this.cards = [];
      };

      Player.prototype.draw = function() {
        var newCard = hanafuda.draw();
        if (newCard) {
          var raster = new Raster(gameImages[newCard.id]);
          raster.position.x = this.start_x + this.cards.length * 80;
          raster.position.y = this.start_y;
          raster.scale(SCALE);

          var shiftRaster = function() {
            this.position += new Point(0, -15);
            for (var i in deck.cards[0]) {
              if (newCard.month == deck.cards[0][i].data.month) {
                matched.push(deck.cards[0][i]);
              }
            }
            for (var i in deck.cards[1]) {
              if (newCard.month == deck.cards[1][i].data.month) {
                matched.push(deck.cards[1][i]);
              }
            }
            for (var i in matched) {
              matched[i].scale(2);
            }
            console.log(matched);
          };
          var unShiftRaster = function() {
            this.position += new Point(0, 15);
          };
          raster.onClick = function() {
            console.log(this.data);
          }
          raster.data = newCard;
          raster.on('mouseenter', shiftRaster);
          raster.on('mouseleave', unShiftRaster);
          this.cards.push(raster);
        } else {
          console.error("No more cards");
        }
      }

      function AI(x, y) {
        this.start_x = x || 48;
        this.start_y = y || -57;
        this.cards = [];
      };

      AI.prototype.draw = function () {
        var newCard = hanafuda.draw();
        if (newCard) {
          var raster = new Raster(gameImages[newCard.id]);
          raster.position.x = this.start_x + (this.cards.length) * 80;
          raster.position.y = this.start_y;
          raster.data = newCard;
          raster.scale(SCALE);
          this.cards.push(raster);
        } else {
          console.error("No more cards");
        }
      }

      function Deck(x, y1, y2) {
        this.start_x = x || 48;
        this.start_y = [
          y1 || 120,
          y2 || 250
        ];
        this.cards = {0: [], 1: []}
      }

      Deck.prototype.draw = function () {
        var newCard = hanafuda.draw();
        if (newCard) {
          var x = 0, y = 0;
          var raster = new Raster(gameImages[newCard.id]);

          if (this.cards[0].length <= this.cards[1].length) {
            x = this.start_x + (Math.floor(this.cards[0].length) + 4) * 80;
            y = this.start_y[0];
            this.cards[0].push(raster);
          } else {
            x = this.start_x + (Math.floor(this.cards[1].length) + 4) * 80;
            y = this.start_y[1];
            this.cards[1].push(raster);
          }
          raster.position.x = x;
          raster.position.y = y;
          raster.data = newCard;
          raster.scale(SCALE);
        } else {
          console.error("No more cards");
        }
      }

      player = new Player();
      ai = new AI();
      deck = new Deck();

      function preloadImages () {
        var cards = hanafuda.fetchAll();
        var loadedImages = 0;
        for (var i in cards) {
          var image = new Image();
          image.id = cards[i].id;
          image.src = "./image/" + cards[i].picture + ".jpg";
          gameImages[cards[i].id] = image;
          image.onload = function(){
            loadedImages++;
            if (loadedImages == cards.length)
              initGame();
          };
        }
      }

      function initGame () {
        for (var i = 0; i < 8 ; i++) {
          player.draw();
          ai.draw();
        }
        for (var i = 0; i < 8 ; i++) {
          deck.draw();
        }
      }
      preloadImages();
    </script>
  </head>
  <body>
    <div id="canvasContainer">
      <canvas id="cardCanvas" width="800" height="600">
        Your browser does not support canvas
      </canvas>
    </div>
  </body
</html>
